<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAV â†’ MP3 å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #2b2b2b;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background-color: #1e1e1e;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #3a3a3a;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 48px;
            color: #f4d03f;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .header p {
            color: #cccccc;
            font-size: 18px;
        }

        .dropzone {
            border: 2px dashed #666666;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            background-color: #2b2b2b;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .dropzone:hover {
            border-color: #f4d03f;
            background-color: #333333;
        }

        .dropzone.dragover {
            border-color: #f4d03f;
            background-color: #333333;
            transform: scale(1.02);
        }

        .dropzone p {
            font-size: 18px;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .dropzone .format {
            color: #999999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            background-color: #3a3a3a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.active {
            display: block;
        }

        .file-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-info p {
            color: #999999;
            font-size: 14px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .convert-button {
            background-color: #f4d03f;
            color: #1e1e1e;
            display: none;
        }

        .convert-button.active {
            display: block;
        }

        .convert-button:hover {
            background-color: #e5c136;
            transform: translateY(-2px);
        }

        .convert-button:disabled {
            background-color: #666666;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 18px;
            color: #4ade80;
            margin-bottom: 20px;
        }

        .success-message.active {
            display: flex;
        }

        .download-button {
            background-color: #5eead4;
            color: #1e1e1e;
            display: none;
        }

        .download-button.active {
            display: block;
        }

        .download-button:hover {
            background-color: #2dd4bf;
            transform: translateY(-2px);
        }

        .progress {
            display: none;
            background-color: #3a3a3a;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress.active {
            display: block;
        }

        .progress-bar {
            background-color: #f4d03f;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: none;
            text-align: center;
            color: #999999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .progress-text.active {
            display: block;
        }

        .error-message {
            display: none;
            color: #ef4444;
            text-align: center;
            margin-bottom: 20px;
        }

        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ WAV â†’ MP3</h1>
            <p>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ãƒ„ãƒ¼ãƒ«</p>
        </div>

        <div class="dropzone" id="dropzone">
            <p>WAVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p class="format">å¯¾å¿œå½¢å¼: .wav</p>
        </div>

        <input type="file" id="fileInput" accept=".wav,audio/wav">

        <div class="file-info" id="fileInfo">
            <h3 id="fileName"></h3>
            <p id="fileSize"></p>
        </div>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

        <button class="button convert-button" id="convertButton">MP3ã«å¤‰æ›</button>

        <div class="success-message" id="successMessage">
            <span>âœ…</span>
            <span>å¤‰æ›å®Œäº†ï¼</span>
        </div>

        <button class="button download-button" id="downloadButton">MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- lamejs library for MP3 encoding -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    
    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const convertButton = document.getElementById('convertButton');
        const successMessage = document.getElementById('successMessage');
        const downloadButton = document.getElementById('downloadButton');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const errorMessage = document.getElementById('errorMessage');

        let selectedFile = null;
        let mp3Blob = null;
        let mp3FileName = '';

        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        dropzone.addEventListener('click', () => {
            fileInput.click();
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        // ãƒ‰ãƒ­ãƒƒãƒ—
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.wav')) {
                showError('WAVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            fileInfo.classList.add('active');
            convertButton.classList.add('active');
            successMessage.classList.remove('active');
            downloadButton.classList.remove('active');
            errorMessage.classList.remove('active');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰MP3ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
            mp3FileName = file.name.replace(/\.wav$/i, '.mp3');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        // å¤‰æ›ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        convertButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            convertButton.disabled = true;
            convertButton.textContent = 'å¤‰æ›ä¸­...';
            progress.classList.add('active');
            progressText.classList.add('active');
            errorMessage.classList.remove('active');
            progressBar.style.width = '0%';

            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                progressText.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                progressBar.style.width = '10%';
                
                const arrayBuffer = await selectedFile.arrayBuffer();
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ã‚³ãƒ¼ãƒ‰
                progressText.textContent = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...';
                progressBar.style.width = '20%';
                
                const audioContext = new AudioContext();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: MP3ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æº–å‚™
                progressText.textContent = 'MP3ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™ä¸­...';
                progressBar.style.width = '30%';
                
                const sampleRate = audioBuffer.sampleRate;
                const channels = audioBuffer.numberOfChannels;
                const kbps = 128;
                
                const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, kbps);
                const mp3Data = [];
                
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
                const sampleBlockSize = 1152;
                const left = audioBuffer.getChannelData(0);
                const right = channels > 1 ? audioBuffer.getChannelData(1) : audioBuffer.getChannelData(0);
                
                // Int16ã«å¤‰æ›
                progressText.textContent = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ä¸­...';
                progressBar.style.width = '40%';
                
                const leftInt16 = new Int16Array(left.length);
                const rightInt16 = new Int16Array(right.length);
                
                for (let i = 0; i < left.length; i++) {
                    leftInt16[i] = Math.max(-32768, Math.min(32767, left[i] * 32768));
                    rightInt16[i] = Math.max(-32768, Math.min(32767, right[i] * 32768));
                }
                
                // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‡¦ç†
                progressText.textContent = 'MP3ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...';
                const totalSamples = leftInt16.length;
                let processedSamples = 0;
                
                for (let i = 0; i < leftInt16.length; i += sampleBlockSize) {
                    const leftChunk = leftInt16.subarray(i, i + sampleBlockSize);
                    const rightChunk = rightInt16.subarray(i, i + sampleBlockSize);
                    const mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
                    if (mp3buf.length > 0) {
                        mp3Data.push(mp3buf);
                    }
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ï¼ˆ40%ã‹ã‚‰90%ã®ç¯„å›²ã§æ›´æ–°ï¼‰
                    processedSamples = i + sampleBlockSize;
                    const encodeProgress = Math.min(processedSamples / totalSamples, 1);
                    const progressValue = 40 + (encodeProgress * 50);
                    progressBar.style.width = progressValue + '%';
                    
                    // 100KBæ¯ã«é€²æ—ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                    if (i % (sampleBlockSize * 100) === 0) {
                        const percent = Math.round(encodeProgress * 100);
                        progressText.textContent = `MP3ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­... ${percent}%`;
                    }
                }
                
                // æ®‹ã‚Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
                progressText.textContent = 'ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å®Œäº†ä¸­...';
                progressBar.style.width = '95%';
                
                const mp3buf = mp3encoder.flush();
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }
                
                // Blobä½œæˆ
                progressText.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...';
                mp3Blob = new Blob(mp3Data, { type: 'audio/mpeg' });
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                console.log('MP3 Blob created:', {
                    size: mp3Blob.size,
                    type: mp3Blob.type,
                    dataLength: mp3Data.length
                });
                
                // å®Œäº†è¡¨ç¤º
                progressBar.style.width = '100%';
                progressText.textContent = 'å¤‰æ›å®Œäº†ï¼';
                
                setTimeout(() => {
                    progress.classList.remove('active');
                    progressText.classList.remove('active');
                    successMessage.classList.add('active');
                    downloadButton.classList.add('active');
                    convertButton.textContent = 'MP3ã«å¤‰æ›';
                    convertButton.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showError('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                convertButton.textContent = 'MP3ã«å¤‰æ›';
                convertButton.disabled = false;
                progress.classList.remove('active');
                progressText.classList.remove('active');
            }
        });

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        downloadButton.addEventListener('click', (event) => {
            if (!mp3Blob) {
                console.error('MP3 Blob ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                return;
            }
            
            console.log('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹:', mp3FileName, mp3Blob.size, 'bytes');
            console.log('Blob type:', mp3Blob.type);
            
            // æ–¹æ³•1: æ¨™æº–çš„ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•
            try {
                const url = URL.createObjectURL(mp3Blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = mp3FileName;
                document.body.appendChild(a);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå†…ã§ç›´æ¥ã‚¯ãƒªãƒƒã‚¯
                a.click();
                
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                console.log('æ–¹æ³•1: æ¨™æº–çš„ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
                
            } catch (error) {
                console.error('æ–¹æ³•1å¤±æ•—:', error);
                
                // æ–¹æ³•2: window.locationã‚’ä½¿ç”¨
                try {
                    const url = URL.createObjectURL(mp3Blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = mp3FileName;
                    a.style.display = 'none';
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ç™ºç«
                    const clickEvent = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: false
                    });
                    
                    document.body.appendChild(a);
                    a.dispatchEvent(clickEvent);
                    document.body.removeChild(a);
                    
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    console.log('æ–¹æ³•2: MouseEventå®Ÿè¡Œ');
                    
                } catch (error2) {
                    console.error('æ–¹æ³•2å¤±æ•—:', error2);
                    
                    // æ–¹æ³•3: æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                    const url = URL.createObjectURL(mp3Blob);
                    
                    // æ—¢å­˜ã®æ‰‹å‹•ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
                    const existingLink = document.querySelector('.manual-download-link');
                    if (existingLink) existingLink.remove();
                    
                    const manualLink = document.createElement('a');
                    manualLink.className = 'manual-download-link';
                    manualLink.href = url;
                    manualLink.download = mp3FileName;
                    manualLink.textContent = 'â¬‡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                    manualLink.style.cssText = `
                        display: block;
                        margin: 20px auto;
                        padding: 15px 30px;
                        background-color: #5eead4;
                        color: #1e1e1e;
                        border-radius: 10px;
                        text-align: center;
                        text-decoration: none;
                        font-weight: bold;
                        font-size: 18px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;
                    
                    manualLink.onmouseover = () => {
                        manualLink.style.backgroundColor = '#2dd4bf';
                        manualLink.style.transform = 'translateY(-2px)';
                    };
                    
                    manualLink.onmouseout = () => {
                        manualLink.style.backgroundColor = '#5eead4';
                        manualLink.style.transform = 'translateY(0)';
                    };
                    
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®å¾Œã«è¿½åŠ 
                    downloadButton.parentNode.insertBefore(manualLink, downloadButton.nextSibling);
                    
                    // ã‚¯ãƒªãƒƒã‚¯å¾Œã«å‰Šé™¤
                    manualLink.addEventListener('click', () => {
                        setTimeout(() => {
                            manualLink.remove();
                            URL.revokeObjectURL(url);
                        }, 1000);
                    });
                    
                    console.log('æ–¹æ³•3: æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º');
                }
            }
        });
    </script>
</body>
</html>